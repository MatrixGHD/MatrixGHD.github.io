# windows 应急响应手册
## 事件预警来源
- 安全设备告警
    - 态势感知
        - 事件时间
        - 源目IP
        - 源目端口
        - 协议
        - 原始数据
        - 返回数据包
    - 防火墙
        - 事件时间
        - 源目IP
        - 源目端口
        - 协议
        - 原始数据
    - EDR
        - 事件时间
        - 攻击方式
        - 恶意文件
        - 源目主机（IP）
        - 源目端口
    - VPN（存在数据中心）
        - 登录时间
        - 源目IP
        - 是否发生暴力破解
- 流量监控设备告警
    - 流量态势图
    - 流量类型
    - 目的IP
    - 目的端口
    - 源 IP
- 工作人员
    - 异常发现时间
    - 主机功能
    - 主机归属
    - 主机技术信息
    - 系统
    - 服务
    - 端口
- 监管单位
    - 攻击通报
    - 被攻击资产
    - 攻击类型
    - 不同事件有不同的角度去处理问题，一次事件可能包含多种类型的事件

## 常规入侵排查
> 善后阶段是所有事件处置都要做的步骤，放在最后一起写，主要内容包括以下几个方面

### 检查账号安全
1、==lusrmgr.msc== 检查是否存在可以新增账号
2、检查是否有隐藏账号及克隆账号
a、打开注册表 ，查看管理员对应键值。
b、使用D盾_web查杀工具，集成了对克隆账号检测的功能。
3、结合日志，查看管理员登录时间、用户名、IP是否存在异常。
导出Windows日志--安全，利用Log Parser进行分析。

### 检查异常端口
a、netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED
b、根据netstat 定位出的pid，再通过tasklist命令进行进程定位 tasklist | findstr “PID”

### 检查异常进程
a、开始--运行--输入msinfo32，依次点击“软件环境→正在运行任务”就可以查看到进程的详细信息，比如进程路径、进程ID、文件创建日期、启动时间等。关注没有签名信息的进程。
b、查看端口对应的PID： netstat -ano | findstr “port”
c、查看进程对应的PID：任务管理器--查看--选择列--PID 或者 tasklist | findstr “PID”

### 检查启动项
a、登录服务器，单击【开始】>【所有程序】>【启动】，默认情况下此目录在是一个空目录，确认是否有非业务
程序在该目录下。 b、单击开始菜单 >【运行】，输入 msconfig，查看是否存在命名异常的启动项目，是则取消
勾选命名异常的启动项目，并到命令中显示的路径删除文件。 
c、单击【开始】>【运行】，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项：
HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce 检查右侧是否有启动异常的项目，如有请删除。
d、利用安全软件查看启动项、开机时间管理等。
e、组策略，运行gpedit.msc。

### 检查计划任务
a、单击【开始】>【设置】>【控制面板】>【任务计划】，查看计划任务属性，便可以发现木马文件的路径。
b、单击【开始】>【运行】；输入 cmd，然后输入at，检查计算机与网络上的其它计算机之间的会话或计划任
务，如有，则确认是否为正常连接。

### 检查服务
单击【开始】>【运行】，输入services.msc，注意服务状态和启动类型，检查是否有异常服务。
查看PID对应的服务：tasklist /svc 进程--PID--服务
查看服务所对应的端口： %system%/system32/drivers/etc/services（一般%system%就是C:\Windows）

### 检查系统相关信息
1、查看系统版本以及补丁信息
检查方法：单击【开始】>【运行】，输入systeminfo，查看系统信息
2、查找可疑目录及文件
检查方法：
a、 查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。
Window 2003 C:\Documents and Settings
Window 2008R2 C:\Users\
b、单击【开始】>【运行】，输入%UserProfile%\Recent，分析最近打开分析可疑文件。
c、在服务器各个目录，可根据文件夹内文件列表时间进行排序，查找可疑文件。
d、回收站、浏览器下载目录、浏览器历史记录
e、修改时间在创建时间之前的为可疑文件
3、得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？
a、利用 Registry Workshop 注册表编辑器的搜索功能，可以找到最后写入时间区间的文件。
b、利用计算机自带文件搜索功能，指定修改时间进行搜索。

### 杀毒工具查杀
- 病毒查杀
Sangfor EDR
火绒

- webshell查杀
D盾
河马
检查方法：选择具体站点路径进行webshell查杀，建议使用两款webshell查杀工具同时查杀，可相互补充规
则库的不足。

### 日志分析
- 系统日志
分析方法：
a、前提：开启审核策略
b、Win+R打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。
C、导出应用程序日志、安全日志、系统日志，利用Log Parser进行分析。
- WEB访问日志
分析方法：
a、找到中间件的web日志，打包到本地方便进行分析。
b、推荐工具：Window下，推荐用 EmEditor 进行日志分析

事件ID：
![-w1178](/img/16255632877981.jpg)
登陆类型：
![-w1171](/img/16255632749609.jpg)

## 挖矿事件

### 0x01 恶意域名、连接的钱包

从内网dns服务器、dns防火墙、流量审计设备等设备获取
根据域名查找木马类型
Virustotal
深信服威胁情报中心
微步在线
venuseye
安恒威胁情报中心
360威胁情报中心
绿盟威胁情报中心
AlienVault
RedQueen安全智能服务平台
IBM X-Force Exchange
ThreatMiner

### 0x02 获取异常进程PID

- 查看服务器资源是否被占用
![-w630](/img/16251036450671.jpg)

- 获取异常进程PID
![-w725](/img/16251040155838.jpg)

- 查看网络连接情况
```
netstat -ano
  -a            显示所有连接和侦听端口。
  -b            显示在创建每个连接或侦听端口时涉及的
                可执行文件。在某些情况下，已知可执行文件托管
                多个独立的组件，此时会
                显示创建连接或侦听端口时
                涉及的组件序列。在此情况下，可执行文件的
                名称位于底部 [] 中，它调用的组件位于顶部，
                直至达到 TCP/IP。注意，此选项
                可能很耗时，并且可能因为你没有足够的
                权限而失败。
  -e            显示以太网统计信息。此选项可以与 -s 选项
                结合使用。
  -f            显示外部地址的完全限定
                域名(FQDN)。
  -n            以数字形式显示地址和端口号。
  -o            显示拥有的与每个连接关联的进程 ID。
  -p proto      显示 proto 指定的协议的连接；proto
                可以是下列任何一个: TCP、UDP、TCPv6 或 UDPv6。如果与 -s
                选项一起用来显示每个协议的统计信息，proto 可以是下列任何一个:
                IP、IPv6、ICMP、ICMPv6、TCP、TCPv6、UDP 或 UDPv6。
  -q            显示所有连接、侦听端口和绑定的
                非侦听 TCP 端口。绑定的非侦听端口
                不一定与活动连接相关联。
  -r            显示路由表。
  -s            显示每个协议的统计信息。默认情况下，
                显示 IP、IPv6、ICMP、ICMPv6、TCP、TCPv6、UDP 和 UDPv6 的统计信息；
                -p 选项可用于指定默认的子网。
  -t            显示当前连接卸载状态。
  -x            显示 NetworkDirect 连接、侦听器和共享
                终结点。
  -y            显示所有连接的 TCP 连接模板。
                无法与其他选项结合使用。
```
![-w612](/img/16251042842318.jpg)

###0x03 寻找恶意文件样本

- 找到恶意进程文件所在位置
![-w694](/img/16251056426870.jpg)

- 查看进程的命令行参数
```
在windows下查看所有运行程序（或进程）的命令行参数
使用下面的命令：
wmic process get caption,commandline /value
wmic process get caption,commandline,processid /value >> tmp.txt
如果想查询某一个进程的命令行参数，使用下列方式：
wmic process where caption=”svchost.exe” get caption,commandline /value
```
![-w657](/img/16251058478213.jpg)

- 访问恶意链接获取恶意样本
如：www.target.com/aaa

- 病毒在线分析
PCHunter
Virustotal
哈勃
jotti
scanvir
魔盾
微步云沙箱
HYBRID
奇安信沙箱

- 寻找病毒分析报告
深信服安全应急响应以及EDR知识赋能平台
深信服EDR团队安全情报分析
深信服安全中心
火绒安全最新资讯
安全客
Freebuf

### 0x04 处理异常进程

- 若不存在守护进程，可直接使用任务管理器进行查杀进程或进程树
常用指令：taskkill /F /T -pid pid
常用参数: /F 强制关闭 /T 结束进程以及子进程，整个进程树
![-w704](/img/16251076408402.jpg)

- 若存在守护进程
    一般来说，如果用户遇到了含有守护进程的程序，则无法完全进行关闭，因为Windows操作系统使用的后台程序管理内核（ntsd.exe）仅支持同时关闭一个程序，这导致带有守护进程的程序无法完全关闭，关闭之后会在守护进程的作用下自动恢复（利用结束进程时产生的时间差）。
　　如果用户确实需要关闭守护进程，则可以尝试同时使用任务管理器、第三方软件和cmd.exe调用ntsd.exe的方式进行进程的终止。
　　
### 0x05 删除恶意文件

- 查看文件占用
任务管理器-->性能-->资源监视器
![-w1242](/img/16251097916440.jpg)
若恶意文件没守护进程，可直接删除

#### 使用processhacker释放控制
Process Hacker给你提供的每一个选项都可以帮助你删掉那些原本删不掉的文件，之所以删不掉，是因为有其他的进程在使用它们…
Process Hacker可以帮助我们识别目标进程，并切断进程跟文件之间的关联，整个处理过程如下：

```
1、 在主菜单中点击“Find handles orDLLs”；
2、 在Filter栏中输入完整或部分文件名，然后点击“Find”；
3、 在结果中找到正确的文件名，然后点击那一行；
4、 点击鼠标右键，从菜单栏中选择“Go toowning process”；
5、 Processes窗口中会高亮标记这个进程；
6、 右键点击高亮进程，选择“Terminate”；
7、 终止进程之后，你就可以尝试删除之前被锁定的文件了；
```

#### 使用安全模式释放控制
若以上方法仍无法删除文件，可进入安全模式进行删除
安全模式是Windows系统一种内置的特殊模式，安全模式的工作原理是在不加载第三方驱动程序的情况下启动电脑，使电脑运行在系统最小模式。这样我们就更方便的删除恶意文件了。

下面以win10为例，进入安全模式
设置-->更新和安全-->恢复-->高级启动-->立即重新启动
疑难解答-->高级选项-->启动设置-->重启-->4或F4
![-w1778](/img/16251103963880.jpg)
![-w1420](/img/16251104219630.jpg)
![-w1426](/img/16251104384393.jpg)
![-w1446](/img/16251104571688.jpg)

![-w1109](/img/16251104852649.jpg)
![-w1228](/img/16251105130254.jpg)

### 0x06 善后阶段
- 完成其余常规入侵排查

## 远控后门

### 0x00 事件来源
木马后门事件主要通过EDR或者态势感知得知
### 0x01 定位后门位置
从EDR或态势感知发现后门文件后，同时也要检查目录里其他可疑文件的内容
==cmd会将内容开头为MZ的任意文件当作pe可执行文件尝试运行，在powershell或gui的话就不行。==
### 0x02 查找进程信息

### 0x03 权限维持检查
#### 注册表自启动
==regedit==
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon 下的shell键值
HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows 下的load键值
无文件注册表后门
Logon Scripts 后门
注册表路径：HKEY_CURRENT_USER\Environment\
创建字符串键值： UserInitMprLogonScript，键值设置为bat的绝对路径：c:\test.bat

#### 组策略自启动
==gpedit.msc==
![-w901](/img/16252173681161.jpg)

#### 计划任务自启动
==at 或 schtasks.exe==
![-w745](/img/16252168099243.jpg)
==taskschd.msc==
![-w1166](/img/16252178118313.jpg)
#### 服务自启动
==services.msc==
注意服务状态和启动类型，检查是否有异常服务。
查看PID对应的服务：tasklist /svc 进程--PID--服务
查看服务所对应的端口： %system%/system32/drivers/etc/services（一般%system%就是C:\Windows）
![-w1000](/img/16252179050415.jpg)
#### WMI 无文件后门
WMI型后门只能由具有管理员权限的用户运行。WMI后门通常使用powershell编写的，可以直接从新的WMI属性中读取和执行后门代码，给代码加密。通过这种方式攻击者会在系统中安装一个持久性的后门，且不会在磁盘中留下任何文件。

WMI型后门主要有两个特征：无文件和无进程。其基本原理是：将代码加密存储在WMI中，达到所谓的无文件；当设定的条件满足时，系统将自动启动powershell进程去执行后门程序，当后门程序执行后进程就会消失。

```powershell
WMI后门检测
# Reviewing WMI Subscriptions using Get-WMIObject
# Event Filter
Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter "Name='Updater'"
# Event Consumer
Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer -Filter "Name='Updater'"
# Binding
Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter "__Path LIKE '%Updater%'"
 
使用Remove-WMIObject命令来删除WMI持久性后门的所有组件。
# Removing WMI Subscriptions using Remove-WMIObject
# Event Filter
Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter "Name='Updater'" | Remove-WmiObject -Verbose
# Event Consumer
Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer -Filter "Name='Updater'" | Remove-WmiObject -Verbose
# Binding
Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter "__Path LIKE '%Updater%'" | Remove-WmiObject -Verbose
```
#### dll 劫持后门
待补充
#### com 劫持后门
```
https://cloud.tencent.com/developer/article/1040608
```
待补充
### 0x04 处理异常进程

- 若不存在守护进程，可直接使用任务管理器进行查杀进程或进程树
常用指令：taskkill /F /T -pid pid
常用参数: /F 强制关闭 /T 结束进程以及子进程，整个进程树
![-w704](/img/16251076408402.jpg)

- 若存在守护进程
    一般来说，如果用户遇到了含有守护进程的程序，则无法完全进行关闭，因为Windows操作系统使用的后台程序管理内核（ntsd.exe）仅支持同时关闭一个程序，这导致带有守护进程的程序无法完全关闭，关闭之后会在守护进程的作用下自动恢复（利用结束进程时产生的时间差）。
　　如果用户确实需要关闭守护进程，则可以尝试同时使用任务管理器、第三方软件和cmd.exe调用ntsd.exe的方式进行进程的终止。
　　
### 0x05 删除恶意文件

- 查看文件占用
任务管理器-->性能-->资源监视器
![-w1242](/img/16251097916440.jpg)
若恶意文件没守护进程，可直接删除

#### 使用processhacker释放控制
Process Hacker给你提供的每一个选项都可以帮助你删掉那些原本删不掉的文件，之所以删不掉，是因为有其他的进程在使用它们…
Process Hacker可以帮助我们识别目标进程，并切断进程跟文件之间的关联，整个处理过程如下：

```
1、 在主菜单中点击“Find handles orDLLs”；
2、 在Filter栏中输入完整或部分文件名，然后点击“Find”；
3、 在结果中找到正确的文件名，然后点击那一行；
4、 点击鼠标右键，从菜单栏中选择“Go toowning process”；
5、 Processes窗口中会高亮标记这个进程；
6、 右键点击高亮进程，选择“Terminate”；
7、 终止进程之后，你就可以尝试删除之前被锁定的文件了；
```

#### 使用安全模式释放控制
若以上方法仍无法删除文件，可进入安全模式进行删除
安全模式是Windows系统一种内置的特殊模式，安全模式的工作原理是在不加载第三方驱动程序的情况下启动电脑，使电脑运行在系统最小模式。这样我们就更方便的删除恶意文件了。

下面以win10为例，进入安全模式
设置-->更新和安全-->恢复-->高级启动-->立即重新启动
疑难解答-->高级选项-->启动设置-->重启-->4或F4
### 0x06 善后阶段
- 完成其余常规入侵排查

## 勒索病毒

### 0x00 简介

对于正常的勒索病毒，一般没啥好的办法，要么交钱，要么格式化，即使找中间商也不会便宜很多
勒索病毒的处置没有那么多技术可言，更多的是策略
### 0x01 确定勒索病毒家族

判断勒索病毒家族并不难，可以从以下几个方面获取

勒索页面主动说明的，直接粘贴到baidu、google里面搜索
勒索加密文件的后缀名
联系邮箱
### 0x02 根据勒索病毒类型寻找解决方法

深信服千里目实验室公众号直接回复病毒关键字
安全响应及EDR知识赋能平台
Freebuf
淘宝、闲鱼
…
### 0x03 解决勒索
“拒绝勒索软件”网站
https://www.nomoreransom.org/zh/index.html
360安全卫士勒索病毒专题
http://lesuobingdu.360.cn

### 0x04 防范措施

一旦中了勒索病毒，文件会被锁死，没有办法正常访问了，这时候，会给你带来极大的困恼。为了防范这样的事情出现，我们电脑上要先做好一些措施：

- 安装杀毒软件，保持监控开启，定期全盘扫描
- 及时更新 Windows安全补丁，开启防火墙临时关闭端口，如445、135、137、138、139、3389等端口
- 及时更新web漏洞补丁，升级web组件
- 备份。重要的资料一定要备份，谨防资料丢失
- 强化网络安全意识，陌生链接不点击，陌生文件不要下载，陌生邮件不要打开


## 暴力破解

### rdp 暴力破解
netstat -ano 确认该服务器开放3389端口
![-w790](/img/16255552693987.jpg)

#### 0x00 日志分析
查看事件查看器==eventvwr.msc==-->Windows日志-->安全
筛选当前日志事件ID：4625，可以发现大量登陆失败日志，登陆类型为10
![-w1131](/img/16255521891505.jpg)

筛选事件ID：4624，查看是否存在审核成功的登陆时间，且登录类型为10，存在则说明被远程登录成功
![-w951](/img/16255541528599.jpg)

应急处理措施：1、关闭外网RDP端口映射 2、断网处置

常见事件ID：
![-w1178](/img/16255632877981.jpg)
登陆类型：
![-w1171](/img/16255632749609.jpg)
较常见的暴力破解登陆类型为3和10，分别对应SMB暴力破解和RDP暴力破解

可对安全日志进行进一步的分析
- 导出安全日志，用logparser进行分析
登录成功的所有事件
.\LogParser.exe -i:EVT –o:DATAGRID "SELECT * FROM  'C:\Program Files (x86)\Log Parser 2.2\all.evtx' where EventID=4624"
![-w1644](/img/16256225457397.jpg)

提取登录成功的用户名和IP：
.\LogParser.exe -i:EVT –o:DATAGRID "SELECT EXTRACT_TOKEN(Message,13,' ') as
EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,'|') as
Username,EXTRACT_TOKEN(Message,38,' ') as Loginip FROM 'C:\Program Files (x86)\Log Parser 2.2\all.evtx' where EventID=4624"
![-w924](/img/16256208582395.jpg)

查看登陆失败用户
.\LogParser.exe -i:EVT "SELECT TimeGenerated AS LoginTime,EXTRACT_TOKEN(Strings,5,'|') as Username FROM 'C:\Program Files (x86)\Log Parser 2.2\all.evtx' WHERE EventID=4625"
![-w844](/img/16255631121645.jpg)

登陆失败的所有事件
.\LogParser.exe -i:EVT –o:DATAGRID "SELECT * FROM 'C:\Program Files (x86)\Log Parser 2.2\all.evtx' where EventID=4625"
![-w1656](/img/16256216713834.jpg)

提取登录失败用户名进行聚合统计：
.\LogParser.exe -i:EVT "SELECT EXTRACT_TOKEN(Message,13,' ') as EventType,EXTRACT_TOKEN(Message,19,' ') as user,count(EXTRACT_TOKEN(Message,19,' ')) as Times,EXTRACT_TOKEN(Message,39,' ') as Loginip FROM 'C:\Program Files (x86)\Log Parser 2.2\all.evtx' where EventID=4625 GROUP BY Message"
![-w853](/img/16256219990651.jpg)

系统历史开关机记录
.\LogParser.exe -i:EVT –o:DATAGRID "SELECT TimeGenerated,EventID,Message FROM 'C:\Program Files (x86)\Log Parser 2.2\all.evtx' where EventID=6005 or EventID=6006"

#### 0x01 检查账号安全
1、==lusrmgr.msc== 检查是否存在可以新增账号
2、检查是否有隐藏账号及克隆账号
a、打开注册表 ，查看管理员对应键值。
b、使用D盾_web查杀工具，集成了对克隆账号检测的功能。
3、结合日志，查看管理员登录时间、用户名、IP是否存在异常。
导出Windows日志--安全，利用Log Parser进行分析。
#### 0x02 处理措施
RDP暴力破解依然十分普遍，如何保护服务器不受暴力破解攻击，总结了几种措施：
1、禁止将RDP端口映射到公网，若必须开放应限定管理IP地址并加强口令安全审计（口令长度不低于8位，由数字、大小写字母、特殊字符等至少两种以上组合构成）。
2、更改服务器RDP默认端口。
3、部署入侵检测设备，增强安全防护。
#### 0x03 善后阶段
- 完成常规入侵排查